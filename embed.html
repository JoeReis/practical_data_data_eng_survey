<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Chart — 2026 State of Data Engineering</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #0d1117;
            --color-bg-elevated: #161b22;
            --color-bg-card: #1c2128;
            --color-border: #30363d;
            --color-text-primary: #e6edf3;
            --color-text-secondary: #8b949e;
            --color-text-muted: #6e7681;
            --color-accent: #58a6ff;
            --color-accent-emphasis: #388bfd;
            --color-accent-muted: #1f6feb33;
            --font-sans: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-mono: 'IBM Plex Mono', 'SF Mono', 'Consolas', monospace;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        [data-theme="light"] {
            --color-bg: #ffffff;
            --color-bg-elevated: #f6f8fa;
            --color-bg-card: #f0f3f6;
            --color-border: #d0d7de;
            --color-text-primary: #1f2328;
            --color-text-secondary: #656d76;
            --color-text-muted: #8c959f;
            --color-accent: #0969da;
            --color-accent-emphasis: #0550ae;
            --color-accent-muted: #0969da22;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            font-family: var(--font-sans);
            background: var(--color-bg);
            color: var(--color-text-primary);
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
        }

        .embed-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 16px;
        }

        .embed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            min-height: 0;
        }

        .embed-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .embed-subtitle {
            font-size: 0.6875rem;
            color: var(--color-text-muted);
            margin-top: 2px;
        }

        .embed-link {
            font-size: 0.6875rem;
            color: var(--color-accent);
            text-decoration: none;
            white-space: nowrap;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .embed-link:hover {
            text-decoration: underline;
        }

        .embed-chart {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        /* Loading state */
        .embed-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--color-text-muted);
            font-size: 0.875rem;
        }

        .embed-loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .embed-error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #f85149;
            font-size: 0.875rem;
            text-align: center;
            padding: 16px;
        }

        /* Chart bar styles (mirrored from main app) */
        .chart-bar-container {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .chart-bar-row {
            display: grid;
            grid-template-columns: 160px 1fr 50px;
            align-items: center;
            gap: 12px;
        }

        .chart-bar-label {
            font-size: 0.8125rem;
            color: var(--color-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chart-bar-track {
            height: 22px;
            background: var(--color-bg-card);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .chart-bar-fill {
            height: 100%;
            border-radius: var(--radius-sm);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chart-bar-value {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--color-text-primary);
            text-align: right;
        }

        /* Footer watermark */
        .embed-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid var(--color-border);
            font-size: 0.625rem;
            color: var(--color-text-muted);
        }

        .embed-footer a {
            color: var(--color-accent);
            text-decoration: none;
        }

        .embed-footer a:hover {
            text-decoration: underline;
        }

        /* Filter badge */
        .embed-filter-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            font-size: 0.625rem;
            font-weight: 500;
            background: var(--color-accent-muted);
            border: 1px solid var(--color-accent);
            border-radius: 999px;
            color: var(--color-accent);
            margin-top: 4px;
        }

        /* Responsive */
        @media (max-width: 400px) {
            .chart-bar-row {
                grid-template-columns: 100px 1fr 35px;
                gap: 8px;
            }
            .chart-bar-label { font-size: 0.75rem; }
            .chart-bar-value { font-size: 0.75rem; }
            .chart-bar-track { height: 18px; }
            .embed-title { font-size: 0.875rem; }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="embed-container">
        <div class="embed-header">
            <div>
                <div class="embed-title" id="chart-title">Loading...</div>
                <div class="embed-subtitle" id="chart-subtitle"></div>
                <div id="filter-badges"></div>
            </div>
            <a class="embed-link" id="explore-link" href="https://thepracticaldata.com/survey/" target="_blank" rel="noopener">Explore full data →</a>
        </div>
        <div class="embed-chart" id="chart-container">
            <div class="embed-loading">
                <div class="embed-loading-spinner"></div>
                Loading chart data...
            </div>
        </div>
        <div class="embed-footer">
            <span>2026 State of Data Engineering Survey • <a href="https://thepracticaldata.com/survey/" target="_blank" rel="noopener">thepracticaldata.com</a></span>
            <span id="chart-count"></span>
        </div>
    </div>

    <script type="module">
        import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm';

        const CHART_COLORS = [
            '#58a6ff', '#3fb950', '#d29922', '#f85149',
            '#a371f7', '#db61a2', '#79c0ff', '#7ee787'
        ];

        const CHART_TITLES = {
            'role': 'By Role',
            'org_size': 'By Organization Size',
            'industry': 'By Industry',
            'ai_usage_frequency': 'AI Usage Frequency',
            'storage_environment': 'Storage Environment',
            'architecture_trend': 'Architecture Trend',
            'team_growth_2026': 'Team Growth Expectations',
            'biggest_bottleneck': 'Biggest Bottleneck',
            'region': 'By Region',
            'modeling_approach': 'Data Modeling Approach',
            'modeling_pain_points': 'Data Modeling Pain Points',
            'education_topic': 'Desired Training Topics'
        };

        const FILTER_LABELS = {
            'role': 'Role',
            'org_size': 'Org Size',
            'industry': 'Industry',
            'region': 'Region',
            'ai_usage_frequency': 'AI Usage'
        };

        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        function truncateText(text, maxLen) {
            if (!text || text.length <= maxLen) return text;
            return text.substring(0, maxLen - 1) + '\u2026';
        }

        // Parse URL params
        const params = new URLSearchParams(window.location.search);
        const column = params.get('col') || 'role';
        const limit = parseInt(params.get('limit')) || 8;
        const metric = params.get('metric') || 'count';
        const theme = params.get('theme') || 'dark';

        // Filters from URL
        const filters = {};
        for (const [key, val] of params.entries()) {
            if (key.startsWith('f_')) {
                filters[key.substring(2)] = val;
            }
        }

        // Set theme
        if (theme === 'light') {
            document.documentElement.setAttribute('data-theme', 'light');
        }

        // Set title
        document.getElementById('chart-title').textContent =
            CHART_TITLES[column] || column.replace(/_/g, ' ');

        // Show filter badges
        const badgesEl = document.getElementById('filter-badges');
        for (const [col, val] of Object.entries(filters)) {
            const badge = document.createElement('span');
            badge.className = 'embed-filter-badge';
            badge.textContent = `${FILTER_LABELS[col] || col}: ${val}`;
            badgesEl.appendChild(badge);
        }

        // Build explore link with filters
        const exploreParams = new URLSearchParams();
        for (const [col, val] of Object.entries(filters)) {
            exploreParams.set(col, val);
        }
        exploreParams.set('tab', 'charts');
        document.getElementById('explore-link').href =
            `https://thepracticaldata.com/survey/?${exploreParams.toString()}`;

        async function init() {
            const container = document.getElementById('chart-container');

            try {
                // Initialize DuckDB
                const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
                const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);
                const workerUrl = URL.createObjectURL(
                    new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })
                );
                const worker = new Worker(workerUrl);
                const logger = new duckdb.ConsoleLogger(duckdb.LogLevel.WARNING);
                const db = new duckdb.AsyncDuckDB(logger, worker);
                await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
                URL.revokeObjectURL(workerUrl);

                const conn = await db.connect();

                // Load data — resolve path relative to embed page
                const response = await fetch('data/survey.parquet');
                const buffer = await response.arrayBuffer();
                await db.registerFileBuffer('survey.parquet', new Uint8Array(buffer));
                await conn.query(`CREATE VIEW survey AS SELECT * FROM read_parquet('survey.parquet')`);

                // Build WHERE clause from filters
                const conditions = [];
                for (const [col, val] of Object.entries(filters)) {
                    conditions.push(`${col} = '${val.replace(/'/g, "''")}'`);
                }
                const whereClause = conditions.length > 0
                    ? `WHERE ${conditions.join(' AND ')}`
                    : '';

                // Get total for percentage calculation
                const totalResult = await conn.query(`SELECT COUNT(*) as c FROM survey ${whereClause}`);
                const totalFiltered = Number(totalResult.toArray()[0].c);

                // Query chart data
                const query = `
                    SELECT ${column} as label, COUNT(*) as count
                    FROM survey
                    ${whereClause}
                    ${whereClause ? 'AND' : 'WHERE'} ${column} IS NOT NULL
                    GROUP BY ${column}
                    ORDER BY count DESC
                    LIMIT ${limit}
                `;
                const result = await conn.query(query);
                const rows = result.toArray();

                if (rows.length === 0) {
                    container.innerHTML = '<div class="embed-error">No data matches these filters</div>';
                    return;
                }

                const maxCount = Math.max(...rows.map(r => Number(r.count)));

                // Render bars
                let html = '<div class="chart-bar-container">';
                rows.forEach((row, i) => {
                    const count = Number(row.count);
                    const barWidth = (count / maxCount) * 100;
                    const color = CHART_COLORS[i % CHART_COLORS.length];
                    const label = truncateText(row.label, 28);

                    let displayValue;
                    if (metric === 'percent') {
                        const pct = totalFiltered > 0 ? (count / totalFiltered) * 100 : 0;
                        displayValue = `${pct.toFixed(1)}%`;
                    } else {
                        displayValue = count.toLocaleString();
                    }

                    html += `
                        <div class="chart-bar-row">
                            <span class="chart-bar-label">${escapeHtml(label)}</span>
                            <div class="chart-bar-track">
                                <div class="chart-bar-fill" data-target-width="${barWidth}" style="width: 0%; background: ${color};"></div>
                            </div>
                            <span class="chart-bar-value">${displayValue}</span>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;

                // Subtitle
                document.getElementById('chart-subtitle').textContent =
                    `${totalFiltered.toLocaleString()} responses`;

                // Count badge
                document.getElementById('chart-count').textContent =
                    `n = ${totalFiltered.toLocaleString()}`;

                // Animate bars
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        container.querySelectorAll('.chart-bar-fill').forEach(fill => {
                            fill.style.width = fill.dataset.targetWidth + '%';
                        });
                    });
                });

                // Clean up
                await conn.close();

            } catch (error) {
                console.error('Embed error:', error);
                container.innerHTML = `<div class="embed-error">Error loading chart: ${escapeHtml(error.message)}</div>`;
            }
        }

        init();
    </script>
</body>
</html>
